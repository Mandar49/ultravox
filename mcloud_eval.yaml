# Ultravox eval with vllm configuration
name: ultravox-vllm-eval
image: mosaicml/composer:latest
compute:
  gpus: 8
  cluster: r15z1p1
integrations:
  - integration_type: git_repo
    git_repo: fixie-ai/ultravox-omni
    git_branch: $UV_BRANCH
    pip_install: poetry==1.7.1
scheduling:
  max_duration: 2  # 2 hours max for jobs to avoid hanging jobs
command: >-
  cd ultravox-omni &&
  poetry install --no-dev &&
  poetry run pip install vllm &&
  HF_TOKEN=$HF_WRITE_TOKEN poetry run python -m ultravox.inference.run_vllm_inference $EVAL_ARGS

# Potentially prefetch weights. The code tries to find the right weights, but if parent job is not found (e.g. deleted), loading weights for a 70B model can be slow.
# poetry run python -m ultravox.training.helpers.prefetch_weights --text_model meta-llama/Meta-Llama-3.1-70B-Instruct &&
env_variables:
  MLFLOW_TRACKING_URI: databricks
  UV_BRANCH: main
  # TODO: the right model path and evalset need to be set below
  EVAL_ARGS: --evalset audio-core --model wandb://fixie/ultravox/model-70B-bs6-ga1-cont:v6
